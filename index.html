<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>投票ページ</title>

<style>
body {
  font-family: sans-serif;
  padding: 24px;
}
button {
  padding: 14px 22px;
  font-size: 18px;
}
</style>

</head>
<body>

<div id="content"></div>

<script>
// ------------------------------
// グローバル設定
// ------------------------------

const GAS_URL = "https://script.google.com/macros/s/AKfycbyrvCWJFbpiXEehVauyZnRfkpM6JWWAHqnJC8UwWEv8ij45erFO-XmQJctC1juM0gNW/exec";

// ------------------------------
// URLパラメータからIDを取得
// ------------------------------

const params = new URLSearchParams(window.location.search);
const voteId = params.get("id");

// ------------------------------
// localStorage：同一端末の再投票防止
// ------------------------------

if (!voteId) {
  document.getElementById("content").innerHTML = "<p>識別番号が無効です。</p>";
} else if (localStorage.getItem("voted") === "true") {
  document.getElementById("content").innerHTML = "<p>すでに投票済みです。</p>";
} else {
  document.getElementById("content").innerHTML = `
    <h2>本当に投票しますか？</h2>
    <button id="voteBtn">投票する</button>
  `;
}

// ------------------------------
// 投票処理
// ------------------------------

document.addEventListener("click", function (e) {
  if (e.target.id === "voteBtn") {
    sendVote();
  }
});

function sendVote() {

  fetch(GAS_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: "id=" + encodeURIComponent(voteId)
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === "success") {
      // 端末に「投票済み」を記録（永久）
      localStorage.setItem("voted", "true");

      document.getElementById("content").innerHTML =
        "<h2>ご協力ありがとうございました！</h2>";
    } else {
      document.getElementById("content").innerHTML =
        "<p>エラーが発生しました：" + res.message + "</p>";
    }
  })
  .catch(err => {
    document.getElementById("content").innerHTML =
      "<p>通信エラーが発生しました。</p>";
  });
}

</script>

</body>
</html>
